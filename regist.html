<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Regist</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <main>
        <div class="login-page">
            <div class="LoginContainer">
                <h2>Sign Up</h2>
                <form id="registForm">   <!--‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å action/method ‡πÄ‡∏õ‡πá‡∏ô id -->
                    <label>email</label>
                    <input type="email" class="box" name="email" id="emailInput" required><br>  <!--‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô type="text" ‡πÄ‡∏õ‡πá‡∏ô type="email" ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° id -->
                    <label>username</label>
                    <input type="text" class="box" name="username" id="usernameInput" required><br> <!--‡πÄ‡∏û‡∏¥‡πà‡∏° id -->
                    <label>password</label>
                    <input type="password" class="box" name="password" id="passwordInput" required><br> <!--‡πÄ‡∏û‡∏¥‡πà‡∏° id -->
                    <button type="submit" class="submitbt" id="signupBtn">Sign Up</button>      <!--‡πÄ‡∏û‡∏¥‡πà‡∏° id -->
                </form>
                
                <div id="registMessage"></div>      <!--‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° -->
            </div>
        </div>
    </main>
    
    <!--Modal  -->
    <div id="verifyModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>üîê Verify OTP</h3>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ OTP<br>‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <input type="text" id="verifyCode" placeholder="000000" maxlength="6"><br>
            <button id="verifyBtn">Verify</button>
            <div id="verifyMessage"></div>
        </div>
    </div>

    <!--‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ OTP ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
    <script>
        let userEmail = '';

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
        document.getElementById('registForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('signupBtn');
            const message = document.getElementById('registMessage');
            const formData = new FormData(e.target);
            
            userEmail = formData.get('email');
            
            btn.disabled = true;
            btn.textContent = 'Sending...';
            message.innerHTML = '';
            
            try {
                const response = await fetch('/regist', {
                    method: 'POST',
                    body: new URLSearchParams(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    message.innerHTML = `<span class="success-message">‚úÖ ${result.message}</span>`;
                    
                    setTimeout(() => {
                        document.getElementById('verifyModal').style.display = 'block';
                        document.getElementById('verifyCode').focus();
                    }, 800);
                } else {
                    message.innerHTML = `<span class="error-message">‚ùå ${result.message}</span>`;
                }
            } catch (error) {
                message.innerHTML = '<span class="error-message">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</span>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sign Up';
            }
        });

        // ‡∏õ‡∏¥‡∏î Modal
        document.querySelector('.close').addEventListener('click', () => {
            document.getElementById('verifyModal').style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            const modal = document.getElementById('verifyModal');
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OTP
        document.getElementById('verifyBtn').addEventListener('click', async () => {
            const otp = document.getElementById('verifyCode').value.trim();
            const btn = document.getElementById('verifyBtn');
            const message = document.getElementById('verifyMessage');
            
            if (otp.length !== 6) {
                message.innerHTML = '<span class="error-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å OTP 6 ‡∏´‡∏•‡∏±‡∏Å</span>';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Verifying...';
            message.innerHTML = '';
            
            try {
                const response = await fetch('/verify', {
                    method: 'POST',
                    body: new URLSearchParams({
                        email: userEmail,
                        otp: otp
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    message.innerHTML = `<span class="success-message">‚úÖ ${result.message}</span>`;
                    
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1500);
                } else {
                    message.innerHTML = `<span class="error-message">‚ùå ${result.message}</span>`;
                    btn.disabled = false;
                    btn.textContent = 'Verify';
                }
            } catch (error) {
                message.innerHTML = '<span class="error-message">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span>';
                btn.disabled = false;
                btn.textContent = 'Verify';
            }
        });

        // ‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        document.getElementById('verifyCode').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        // ‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
        document.getElementById('verifyCode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('verifyBtn').click();
            }
        });
    </script>

    <script src="/main.js"></script>
</body>
</html>